# DEFINE PARAMETERS OF SPECKLE AND NORMALIZATION FACTOR
# import numpy as np
# from scipy import special
#
# M = 10.089038980848645
# m = -1.429329123112601
# L = 1
# c = (1 / 2) * (special.psi(L) - np.log(L))
# cn = c / (M - m)  # normalized (0,1) mean of log speckle
#
# def normalize_sar(im):
#     return ((np.log(np.clip(im, 0.24, np.max(im))) - m) / (M - m)).astype('float32')
#
# def denormalize_sar(im):
#     return np.exp((M - m) * np.clip((np.squeeze(im)).astype('float32'),0,1) + m)
import imageio
import numpy as np
import torchvision
import matplotlib.pyplot as plt
from utils import metrics
to_tensor = torchvision.transforms.ToTensor()
# nor_test = imageio.v3.imread('../scratch/data/synthesis_v1/test/test_02.png')
# nor_test = (nor_test / 255.0).astype(np.float32)
# print(np.max(nor_test), np.min(nor_test))
# imageio.imwrite('../scratch/data/synthesis_v1/test/test_02_float.tif', nor_test)

imgv1 = imageio.v3.imread(r'../results/images/SAR/Synthesis_no_log_SAR/v1/test_01_float_output.tif')
imgv1_UC = imageio.v3.imread(r'../results/images/SAR/Synthesis_no_log_SAR/v19_v11/test_01_float_output.tif')
imgv4 = imageio.v3.imread(r'../results/images/SAR/Synthesis_no_log_SAR/v17_v4/test_01_float_output.tif')
imgv7 = imageio.v3.imread(r'../results/images/SAR/Synthesis_no_log_SAR/v18_v7/test_01_float_output.tif')
imgv7_UC = imageio.v3.imread(r'../results/images/SAR/Synthesis_no_log_SAR/v20/test_01_float_output.tif')
noisy1 = imageio.v3.imread(r'../scratch/data/synthesis_v1/test/test_01_float.tif')
# print(metrics.compute_enl(imgv1[340:370, 405:425]))
imgcam1 = imageio.v3.imread(r'E:\SAR-CAM\data\test_real_sar\outputUC\test_01_float.tif')
imgcamS2 = imageio.v3.imread(r'E:\SAR-CAM\data\test_real_sar\output\test_01_float.tif')
# print(metrics.compute_enl(imgcam[340:370, 405:425]))
imgtrans1 = imageio.v3.imread(r'E:\sar_transformer\int_test\test_01_float_output.tif')
imgtransUC1 = imageio.v3.imread(r'E:\sar_transformer\int_test\test_01_float_UC_output.tif')
imgon1 = imageio.v3.imread(r'E:\sar_overcomplete\int_test\test_01_float_output.tif')
imgonUC1 = imageio.v3.imread(r'E:\sar_overcomplete\int_test\test_01_float_UC_output.tif')
imgPPB1 = imageio.v3.imread(r'H:\ppbNakagami\test_01_float_output.tif')
# print(metrics.compute_enl(imgtrans[340:370, 405:425]))
#imgtrans1 = (imgtrans1 / 255.0).astype(np.float32)

morv1 = metrics.compute_MOR(imgv1[329:377, 352:366], noisy1[329:377, 352:366])
morv1_UC = metrics.compute_MOR(imgv1_UC[329:377, 352:366], noisy1[329:377, 352:366])
morv7 = metrics.compute_MOR(imgv7[329:377, 352:366], noisy1[329:377, 352:366])
morv7_UC = metrics.compute_MOR(imgv7_UC[329:377, 352:366], noisy1[329:377, 352:366])
morcam1 = metrics.compute_MOR(imgcam1[329:377, 352:366], noisy1[329:377, 352:366])
morcamS2 = metrics.compute_MOR(imgcamS2[329:377, 352:366], noisy1[329:377, 352:366])
mortrans1 = metrics.compute_MOR(imgtrans1[329:377, 352:366], noisy1[329:377, 352:366])
mortransUC1 = metrics.compute_MOR(imgtransUC1[329:377, 352:366], noisy1[329:377, 352:366])
moron1 = metrics.compute_MOR(imgon1[329:377, 352:366], noisy1[329:377, 352:366])
moronUC1 = metrics.compute_MOR(imgonUC1[329:377, 352:366], noisy1[329:377, 352:366])
morPPB1 = metrics.compute_MOR(imgPPB1[329:377, 352:366], noisy1[329:377, 352:366])

imgv1 =to_tensor(imgv1[329:377, 352:366]).unsqueeze(0)
imgv1_UC =to_tensor(imgv1_UC[329:377, 352:366]).unsqueeze(0)
imgv4 =to_tensor(imgv4[329:377, 352:366]).unsqueeze(0)
imgv7 =to_tensor(imgv7[329:377, 352:366]).unsqueeze(0)
imgv7_UC =to_tensor(imgv7_UC[329:377, 352:366]).unsqueeze(0)
noisy1 = to_tensor(noisy1[329:377, 352:366]).unsqueeze(0)
imgcam1 =to_tensor(imgcam1[329:377, 352:366]).unsqueeze(0)
imgcamS2 =to_tensor(imgcamS2[329:377, 352:366]).unsqueeze(0)
imgtrans1 =to_tensor(imgtrans1[329:377, 352:366]).unsqueeze(0)
imgtransUC1 =to_tensor(imgtransUC1[329:377, 352:366]).unsqueeze(0)
imgon1 =to_tensor(imgon1[329:377, 352:366]).unsqueeze(0)
imgonUC1 =to_tensor(imgonUC1[329:377, 352:366]).unsqueeze(0)
imgPPB1 =to_tensor(imgPPB1[329:377, 352:366]).unsqueeze(0)

enlv1 = metrics.compute_enl(imgv1)
moiv1 = metrics.calculate_MoI(imgv1, noisy1)
Cxv1 = metrics.calculate_Cx(imgv1)

enlv1_UC = metrics.compute_enl(imgv1_UC)
moiv1_UC = metrics.calculate_MoI(imgv1_UC, noisy1)
Cxv1_UC = metrics.calculate_Cx(imgv1_UC)

enlv4 = metrics.compute_enl(imgv4)
moiv4 = metrics.calculate_MoI(imgv4, noisy1)
Cxv4 = metrics.calculate_Cx(imgv4)

enlv7 = metrics.compute_enl(imgv7)
moiv7 = metrics.calculate_MoI(imgv7, noisy1)
Cxv7 = metrics.calculate_Cx(imgv7)

enlv7_UC = metrics.compute_enl(imgv7_UC)
moiv7_UC = metrics.calculate_MoI(imgv7_UC, noisy1)
Cxv7_UC = metrics.calculate_Cx(imgv7_UC)

enlcam = metrics.compute_enl(imgcam1)
moicam = metrics.calculate_MoI(imgcam1, noisy1)
Cxcam = metrics.calculate_Cx(imgcam1)

enlcamS2 = metrics.compute_enl(imgcamS2)
moicamS2 = metrics.calculate_MoI(imgcamS2, noisy1)
CxcamS2 = metrics.calculate_Cx(imgcamS2)

enltrans = metrics.compute_enl(imgtrans1)
moitrans = metrics.calculate_MoI(imgtrans1, noisy1)
Cxtrans = metrics.calculate_Cx(imgtrans1)

enltransUC1 = metrics.compute_enl(imgtransUC1)
moitransUC1 = metrics.calculate_MoI(imgtransUC1, noisy1)
CxtransUC1 = metrics.calculate_Cx(imgtransUC1)

enlon = metrics.compute_enl(imgon1)
moion = metrics.calculate_MoI(imgon1, noisy1)
Cxon = metrics.calculate_Cx(imgon1)

enlonUC1 = metrics.compute_enl(imgonUC1)
moionUC1 = metrics.calculate_MoI(imgonUC1, noisy1)
CxonUC1 = metrics.calculate_Cx(imgonUC1)

enlppb = metrics.compute_enl(imgPPB1)
moippb = metrics.calculate_MoI(imgPPB1, noisy1)
Cxppb = metrics.calculate_Cx(imgPPB1)

print('test_01')
print('ENLv1:', enlv1)
print('ENLv1_UC:', enlv1_UC)
print('ENLv4:', enlv4)
print('ENLv7:', enlv7)
print('ENLv7_UC:', enlv7_UC)
print('ENLcamUC:', enlcam)
print('ENLcamS2:', enlcamS2)
print('ENLtrans:', enltrans)
print('ENLtransUC1:', enltransUC1)
print('ENLon:', enlon)
print('ENLonUC1:', enlonUC1)
print('ENLPPB1:', enlppb)

print('MOIv1:', moiv1)
print('MOIv1_UC:', moiv1_UC)
print('MOIv4:', moiv4)
print('MOIv7:', moiv7)
print('MOIv7_UC:', moiv7_UC)
print('MOIcamUC:', moicam)
print('MOIcamS2:', moicamS2)
print('MOItrans:', moitrans)
print('MOItransUC1:', moitransUC1)
print('MOIon:', moion)
print('MOIonUC1:', moionUC1)
print('MOIPPB1:', moippb)

print('MORv1:', morv1)
print('MORv1_UC:', morv1_UC)
print('MORv7:', morv7)
print('MORv7_UC:', morv7_UC)
print('MORcamUC:', morcam1)
print('MORcamS2:', morcamS2)
print('MORtrans:', mortrans1)
print('MORtransUC1:', mortransUC1)
print('MORon:', moron1)
print('MORonUC1:', moronUC1)
print('MORPPB1:', morPPB1)


print('Cxv1:', Cxv1)
print('Cxv1_UC:', Cxv1_UC)
print('Cxv4:', Cxv4)
print('Cxv7:', Cxv7)
print('Cxv7_UC:', Cxv7_UC)
print('CxcamUC:', Cxcam)
print('CxcamS2:', CxcamS2)
print('Cxtrans:', Cxtrans)
print('CxtransUC1:', CxtransUC1)
print('Cxon:', Cxon)
print('CxonUC1:', CxonUC1)
print('CxPPB1:', Cxppb)

print('-'*50)

imgv1_2 = imageio.v3.imread(r'../results/images/SAR/Synthesis_no_log_SAR/v1/test_02_float_output.tif')
imgv1_UC_2 = imageio.v3.imread(r'../results/images/SAR/Synthesis_no_log_SAR/v19_v11/test_02_float_output.tif')
imgv4_2 = imageio.v3.imread(r'../results/images/SAR/Synthesis_no_log_SAR/v17_v4/test_02_float_output.tif')
imgv7_2 = imageio.v3.imread(r'../results/images/SAR/Synthesis_no_log_SAR/v18_v7/test_02_float_output.tif')
imgv7_UC_2 = imageio.v3.imread(r'../results/images/SAR/Synthesis_no_log_SAR/v20/test_02_float_output.tif')
noisy2 = imageio.v3.imread(r'../scratch/data/synthesis_v1/test/test_02_float.tif')
imgcam2 = imageio.v3.imread(r'E:\SAR-CAM\data\test_real_sar\outputUC\test_02_float.tif')    #UCmerced
imgcamS2 = imageio.v3.imread(r'E:\SAR-CAM\data\test_real_sar\output\test_02_float.tif')
imgtrans2 = imageio.v3.imread(r'E:\sar_transformer\int_test\test_02_float_output.tif')
imgtransUC2 = imageio.v3.imread(r'E:\sar_transformer\int_test\test_02_float_UC_output.tif')
imgon2 = imageio.v3.imread(r'E:\sar_overcomplete\int_test\test_02_float_output.tif')
imgonUC2 = imageio.v3.imread(r'E:\sar_overcomplete\int_test\test_02_float_UC_output.tif')
imgPPB2 = imageio.v3.imread(r'H:\ppbNakagami\test_02_float_output.tif')

morv1_2 = metrics.compute_MOR(imgv1_2[260:290, 230:260], noisy2[260:290, 230:260])
morv1_UC_2 = metrics.compute_MOR(imgv1_UC_2[260:290, 230:260], noisy2[260:290, 230:260])
morv7_2 = metrics.compute_MOR(imgv7_2[260:290, 230:260], noisy2[260:290, 230:260])
morv7_UC_2 = metrics.compute_MOR(imgv7_UC_2[260:290, 230:260], noisy2[260:290, 230:260])
morcam2 = metrics.compute_MOR(imgcam2[260:290, 230:260], noisy2[260:290, 230:260])
morcamS2 = metrics.compute_MOR(imgcamS2[260:290, 230:260], noisy2[260:290, 230:260])
mortrans2 = metrics.compute_MOR(imgtrans2[260:290, 230:260], noisy2[260:290, 230:260])
mortransUC2 = metrics.compute_MOR(imgtransUC2[260:290, 230:260], noisy2[260:290, 230:260])
moron2 = metrics.compute_MOR(imgon2[260:290, 230:260], noisy2[260:290, 230:260])
moronUC2 = metrics.compute_MOR(imgonUC2[260:290, 230:260], noisy2[260:290, 230:260])
morPPB2 = metrics.compute_MOR(imgPPB2[260:290, 230:260], noisy2[260:290, 230:260])

imgv1_2 = to_tensor(imgv1_2[260:290, 230:260]).unsqueeze(0)
imgv1_UC_2 = to_tensor(imgv1_UC_2[260:290, 230:260]).unsqueeze(0)
imgv4_2 = to_tensor(imgv4_2[260:290, 230:260]).unsqueeze(0)
imgv7_2 = to_tensor(imgv7_2[260:290, 230:260]).unsqueeze(0)
imgv7_UC_2 = to_tensor(imgv7_UC_2[260:290, 230:260]).unsqueeze(0)
noisy2 = to_tensor(noisy2[260:290, 230:260]).unsqueeze(0)
imgcam2 =to_tensor(imgcam2[260:290, 230:260]).unsqueeze(0)
imgcamS2 =to_tensor(imgcamS2[260:290, 230:260]).unsqueeze(0)
imgtrans2 =to_tensor(imgtrans2[260:290, 230:260]).unsqueeze(0)
imgtransUC2 =to_tensor(imgtransUC2[260:290, 230:260]).unsqueeze(0)
imgon2 =to_tensor(imgon2[260:290, 230:260]).unsqueeze(0)
imgonUC2 =to_tensor(imgonUC2[260:290, 230:260]).unsqueeze(0)
imgPPB2 =to_tensor((imgPPB2[329:377, 352:366] / 255.0).astype(np.float32)).unsqueeze(0)

enlv1_2 = metrics.compute_enl(imgv1_2)
enlv1_UC_2 = metrics.compute_enl(imgv1_UC_2)
enlv4_2 = metrics.compute_enl(imgv4_2)
enlv7_2 = metrics.compute_enl(imgv7_2)
enlv7_UC_2 = metrics.compute_enl(imgv7_UC_2)
enlcam2 = metrics.compute_enl(imgcam2)
enlcamS2 = metrics.compute_enl(imgcamS2)
enltrans2 = metrics.compute_enl(imgtrans2)
enltransUC2 = metrics.compute_enl(imgtransUC2)
enlon2 = metrics.compute_enl(imgon2)
enlonUC2 = metrics.compute_enl(imgonUC2)
enlPPB2 = metrics.compute_enl(imgPPB2)

moiv1_2 = metrics.calculate_MoI(imgv1_2, noisy2)
moiv1_UC_2 = metrics.calculate_MoI(imgv1_UC_2, noisy2)
moiv4_2 = metrics.calculate_MoI(imgv4_2, noisy2)
moiv7_2 = metrics.calculate_MoI(imgv7_2, noisy2)
moiv7_UC_2 = metrics.calculate_MoI(imgv7_UC_2, noisy2)
moicamUC_2 = metrics.calculate_MoI(imgcam2, noisy2)
moicamS2_2 = metrics.calculate_MoI(imgcamS2, noisy2)
moitrans2 = metrics.calculate_MoI(imgtrans2, noisy2)
moitransUC2 = metrics.calculate_MoI(imgtransUC2, noisy2)
moion2 = metrics.calculate_MoI(imgon2, noisy2)
moionUC2 = metrics.calculate_MoI(imgonUC2, noisy2)
moiPPB2 = metrics.calculate_MoI(imgPPB2, noisy2)

Cxv1_2 = metrics.calculate_Cx(imgv1_2)
Cxv1_UC_2 = metrics.calculate_Cx(imgv1_UC_2)
Cxv4_2 = metrics.calculate_Cx(imgv4_2)
Cxv7_2 = metrics.calculate_Cx(imgv7_2)
Cxv7_UC_2 = metrics.calculate_Cx(imgv7_UC_2)
CxcamUC2 = metrics.calculate_Cx(imgcam2)
CxcamS2 = metrics.calculate_Cx(imgcamS2)
Cxtrans2 = metrics.calculate_Cx(imgtrans2)
CxtransUC2 = metrics.calculate_Cx(imgtransUC2)
Cxon2 = metrics.calculate_Cx(imgon2)
CxonUC2 = metrics.calculate_Cx(imgonUC2)
CxPPB2 = metrics.calculate_Cx(imgPPB2)

print('test_02')
print('ENLv1_2:', enlv1_2)
print('ENLv1_UC_2:', enlv1_UC_2)
print('ENLv4_2:', enlv4_2)
print('ENLv7_2:', enlv7_2)
print('ENLv7_UC_2:', enlv7_UC_2)
print('ENLcamUC:', enlcam2)
print('ENLcamS2:', enlcamS2)
print('ENLtrans2:', enltrans2)
print('ENLtransUC2:', enltransUC2)
print('ENLon2:', enlon2)
print('ENLonUC2:', enlonUC2)
print('ENLPPB2:', enlPPB2)

print('MOIv1_2:', moiv1_2)
print('MOIv1_UC_2:', moiv1_UC_2)
print('MOIv4_2:', moiv4_2)
print('MOIv7_2:', moiv7_2)
print('MOIv7_UC_2:', moiv7_UC_2)
print('MOIcamUC_2:', moicamUC_2)
print('MOIcamS2_2:', moicamS2_2)
print('MOItrans2:', moitrans2)
print('MOItransUC2:', moitransUC2)
print('MOIon2:', moion2)
print('MOIonUC2:', moionUC2)
print('MOIPPB2:', moiPPB2)

print('MORv1_2:', morv1_2)
print('MORv1_UC_2:', morv1_UC_2)
print('MORv7_2:', morv7_2)
print('MORv7_UC_2:', morv7_UC_2)
print('MORcamUC_2:', morcam2)
print('MORcamS2_2:', morcamS2)
print('MORtrans2:', mortrans2)
print('MORtransUC2:', mortransUC2)
print('MORon2:', moron2)
print('MORonUC2:', moronUC2)
print('MORPPB2:', morPPB2)

print('Cxv1_2:', Cxv1_2)
print('Cxv1_UC_2:', Cxv1_UC_2)
print('Cxv4_2:', Cxv4_2)
print('Cxv7_2:', Cxv7_2)
print('Cxv7_UC_2:', Cxv7_UC_2)
print('CxcamUC2:', CxcamUC2)
print('CxcamS2:', CxcamS2)
print('Cxtrans2:', Cxtrans2)
print('CxtransUC2:', CxtransUC2)
print('Cxon2:', Cxon2)
print('CxonUC2:', CxonUC2)
print('CxPPB2:', CxPPB2)


# import pywt
# img = imageio.v3.imread(r'E:\SARDiffusion\scratch\data\synthesis_v1\test\20211130_716.tif')
# [cl, (cH4, cV4, cD4), (cH3, cV3, cD3), (cH2, cV2, cD2), (cH1, cV1, cD1)] = pywt.wavedec2(img, 'db1', level=4)
# print(cH1.shape, cH2.shape, cD1.shape)
# imageio.imwrite('cH1.tif', cH1)
# imageio.imwrite('cH2.tif', cH2)
# imageio.imwrite('cD1.tif', cD1)